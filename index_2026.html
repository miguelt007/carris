<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Carris Metropolitana ‚Äì Teste Mock</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
html, body { margin:0; height:100%; font-family: Arial, sans-serif; }
#map { height:100%; width:100%; }

#header {
  position:absolute; top:10px; left:50%; transform:translateX(-50%);
  z-index:1000; background: rgba(0,0,0,0.5); padding:10px 20px; border-radius:10px;
  display:flex; align-items:center; gap:10px; color:white; font-weight:bold; font-size:18px;
  box-shadow:0 4px 10px rgba(0,0,0,0.3);
}
.live-indicator { width:12px; height:12px; background:#27ae60; border-radius:50%; animation:blink 1s infinite; }
@keyframes blink { 0%,50%,100%{opacity:1;} 25%,75%{opacity:0.2;} }

#botao-centro {
  position:absolute; bottom:20px; right:20px; z-index:999;
  background:white; border:2px solid #333; border-radius:50%; width:48px; height:48px;
  font-size:24px; text-align:center; line-height:44px; cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,0.3);
}
.leaflet-popup-content { max-height:250px; overflow-y:auto; }
</style>
</head>
<body>

<div id="header">
  <span class="live-indicator"></span> Carris Metropolitana ‚Äì Teste Mock
</div>
<div id="map"></div>
<button id="botao-centro">&#9673;</button>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/gh/bbecquet/Leaflet.RotatedMarker@master/leaflet.rotatedMarker.js"></script>
<script>
// Inicializar mapa
const map = L.map('map').setView([38.736946, -9.142685], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  attribution:'¬© OpenStreetMap contributors'
}).addTo(map);

// Bot√£o para centrar no utilizador
let marcadorUtilizador;
navigator.geolocation.watchPosition(pos=>{
  const {latitude,longitude} = pos.coords;
  if(!marcadorUtilizador) marcadorUtilizador = L.marker([latitude,longitude]).addTo(map);
  else marcadorUtilizador.setLatLng([latitude,longitude]);
});
document.getElementById('botao-centro').addEventListener('click',()=>{ if(marcadorUtilizador) map.setView(marcadorUtilizador.getLatLng(),15); });

// √çcone retangular com seta
function createBusSVGIcon(line){
  const rectWidth = 40;
  const height = 20;
  const padding = 4;
  const arrowWidth = 10;
  const svg = `
  <svg xmlns="http://www.w3.org/2000/svg" width="${rectWidth+arrowWidth}" height="${height}" viewBox="0 0 ${rectWidth+arrowWidth} ${height}">
    <rect x="0" y="0" width="${rectWidth}" height="${height}" fill="#FFD100" stroke="black" rx="3" ry="3"/>
    <text x="${padding}" y="${height/2 + 5}" font-size="12" text-anchor="start" fill="black" font-family="Arial" font-weight="bold">${line}</text>
    <polygon points="${rectWidth},${height/2 - 5} ${rectWidth},${height/2 + 5} ${rectWidth+arrowWidth},${height/2}" fill="black"/>
  </svg>`;
  return L.icon({
    iconUrl: "data:image/svg+xml;base64," + btoa(svg),
    iconSize: [rectWidth + arrowWidth, height],
    iconAnchor: [(rectWidth + arrowWidth)/2, height/2]
  });
}

// Fun√ß√£o utilit√°ria para status
function traduzirStatus(status){
  switch(status){
    case "INCOMING_AT": return "A chegar √† paragem";
    case "STOPPED_AT": return "Parado na paragem";
    case "IN_TRANSIT_TO": return "Em tr√¢nsito";
    default: return "Desconhecido";
  }
}

// Marcadores existentes
const marcadoresBuses = new Map();

// Interpola√ß√£o linear
function lerp(a,b,t){ return a + (b-a)*t; }
function interpolateLatLng(latlng1, latlng2, t){ return [lerp(latlng1[0],latlng2[0],t), lerp(latlng1[1],latlng2[1],t)]; }

// Anima√ß√£o do marcador
function animateMarker(mObj, newPos, newAngle, duration=30000){
  const startTime = performance.now();
  const startPos = mObj.currentPos || newPos.slice();
  const startAngle = mObj.currentAngle != null ? mObj.currentAngle : newAngle;

  function frame(time){
    const t = Math.min((time-startTime)/duration,1);
    const pos = interpolateLatLng(startPos,newPos,t);
    const angle = lerp(startAngle,newAngle,t);
    mObj.marker.setLatLng(pos);
    mObj.marker.setRotationAngle(angle);
    mObj.currentPos = pos;
    mObj.currentAngle = angle;
    if(t<1) mObj.animFrame = requestAnimationFrame(frame);
    else mObj.animFrame = null;
  }
  if(mObj.animFrame) cancelAnimationFrame(mObj.animFrame);
  mObj.animFrame = requestAnimationFrame(frame);
}

// Calcular bearing real entre duas posi√ß√µes
function calculateBearing(lat1, lon1, lat2, lon2){
  const dLon = (lon2-lon1) * Math.PI/180;
  const y = Math.sin(dLon) * Math.cos(lat2*Math.PI/180);
  const x = Math.cos(lat1*Math.PI/180)*Math.sin(lat2*Math.PI/180) -
            Math.sin(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.cos(dLon);
  return (Math.atan2(y,x) * 180/Math.PI + 360) % 360;
}

// Dados simulados
let testVehicles = [
  {id:"1",line_id:"4701",lat:38.7369,lon:-9.1426,current_status:"IN_TRANSIT_TO"},
  {id:"2",line_id:"7301",lat:38.7400,lon:-9.1500,current_status:"IN_TRANSIT_TO"},
  {id:"3",line_id:"7901",lat:38.7300,lon:-9.1350,current_status:"IN_TRANSIT_TO"}
];

// Atualiza posi√ß√µes de teste a cada 30s
function moveMockVehicles(){
  testVehicles.forEach(v=>{
    v.prevLat = v.lat;
    v.prevLon = v.lon;
    v.lat += (Math.random()-0.5)*0.0015;
    v.lon += (Math.random()-0.5)*0.0015;
    // Bearing ser√° calculado depois
  });
}

// Carregar "autocarros" de teste
async function carregarAutocarros(){
  moveMockVehicles();
  testVehicles.forEach(v=>{
    const {id, line_id, lat, lon, prevLat, prevLon, current_status} = v;
    const headsign = "Teste destino";
    const paragens = ["Paragem A","Paragem B","Paragem C"];
    const estado = traduzirStatus(current_status);
    const horaAtual = new Date().toLocaleTimeString("pt-PT",{hour12:false});

    const popupHTML = `
      üöå <strong>Autocarro ${id}</strong><br>
      <b>Linha:</b> ${line_id}<br>
      <b>Destino:</b> ${headsign}<br>
      <b>Estado:</b> ${estado}<br>
      <b>Atualiza√ß√£o:</b> ${horaAtual}<br>
      <br><strong>Pr√≥ximas paragens:</strong><br>${paragens.join('<br>')}
    `;

    const realBearing = prevLat != null ? calculateBearing(prevLat, prevLon, lat, lon) : 0;

    if(!marcadoresBuses.has(id)){
      const marker = L.marker([lat, lon], {
        icon: createBusSVGIcon(line_id),
        rotationAngle: realBearing,
        rotationOrigin:'center'
      }).addTo(map);
      marker.bindPopup(popupHTML);
      marcadoresBuses.set(id,{marker,currentPos:[lat,lon],currentAngle:realBearing,animFrame:null});
    } else {
      const mObj = marcadoresBuses.get(id);
      mObj.marker._popup.setContent(popupHTML);
      animateMarker(mObj, [lat, lon], realBearing, 30000);
    }
  });
}

// Inicializa e atualiza a cada 30s
carregarAutocarros();
setInterval(carregarAutocarros,30000);
</script>
</body>
</html>
