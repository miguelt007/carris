<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Carris Metropolitana – Live</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html,body{
  margin:0;
  height:100%;
  overflow:hidden;
  font-family:Arial;
}
#map{ height:100%; }
#header{
  position:absolute;
  top:15px;
  left:50%;
  transform:translateX(-50%);
  z-index:1000;
  background:rgba(0,0,0,0.8);
  padding:12px 20px;
  border-radius:10px;
  color:white;
  font-weight:bold;
}
</style>
</head>
<body>

<div id="header">
Carris Metropolitana – Live
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/gh/bbecquet/Leaflet.RotatedMarker@master/leaflet.rotatedMarker.js"></script>

<script>

// MAPA
const map = L.map('map').setView([38.736946, -9.142685], 12);

L.tileLayer(
  "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
  { attribution:"© OpenStreetMap" }
).addTo(map);


// ÍCONE
function createBusIcon(line){

  const h = 20;
  const rectW = 30 + (line ? line.length*6 : 10);
  const arrowW = 10;
  const w = rectW + arrowW;

  const svg = `
  <svg xmlns="http://www.w3.org/2000/svg"
       width="${w}" height="${h}">
    <rect width="${rectW}" height="${h}"
          fill="#FFD100" stroke="black"
          rx="4"/>
    <text x="6" y="${h/2+5}"
          font-size="12"
          font-weight="bold">
      ${line || "?"}
    </text>
    <polygon points="${rectW},${h/2-5}
                     ${rectW},${h/2+5}
                     ${w},${h/2}"
             fill="black"/>
  </svg>`;

  return L.icon({
    iconUrl:"data:image/svg+xml;base64,"+btoa(svg),
    iconSize:[w,h],
    iconAnchor:[w,h/2]
  });
}


// VEÍCULOS
const markers = new Map();

async function updateVehicles(){

  try{

    const vehicles = await fetch(
      "https://api.carrismetropolitana.pt/v2/vehicles"
    ).then(r=>r.json());

    vehicles.forEach(v=>{

      if(v.lat == null || v.lon == null)
        return;

      const popup = `
        <b>ID:</b> ${v.id}<br>
        <b>Vehicle ID:</b> ${v.vehicle_id}<br>
        <b>Linha:</b> ${v.line_id}<br>
        <b>Pattern:</b> ${v.pattern_id}<br>
        <b>Trip:</b> ${v.trip_id}<br>
        <b>Status:</b> ${v.current_status}<br>
        <b>Velocidade:</b> ${v.speed ? Math.round(v.speed*3.6) : 0} km/h<br>
        <b>Bearing:</b> ${v.bearing}<br>
        <b>Stop ID:</b> ${v.stop_id}<br>
        <b>Lat:</b> ${v.lat}<br>
        <b>Lon:</b> ${v.lon}<br>
        <b>Timestamp:</b> ${v.timestamp}
      `;

      if(!markers.has(v.id)){

        const marker = L.marker([v.lat, v.lon],{
          icon: createBusIcon(v.line_id),
          rotationAngle: v.bearing || 0,
          rotationOrigin: "center center"
        }).addTo(map);

        marker.bindPopup(popup);

        markers.set(v.id, marker);

      } else {

        const m = markers.get(v.id);
        m.setLatLng([v.lat,v.lon]);
        m.setRotationAngle(v.bearing || 0);
        m.getPopup().setContent(popup);
      }

    });

  } catch(e){
    console.error("Erro API:", e);
  }
}

updateVehicles();
setInterval(updateVehicles, 30000);

</script>
</body>
</html>
