<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Carris Metropolitana ‚Äì Live (v2 API)</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
html,body{margin:0;height:100%;overflow:hidden;font-family:Arial;}
#map{height:100%;width:100%;}
#header{position:absolute;top:10px;left:50%;transform:translateX(-50%);z-index:1000;
  background:rgba(0,0,0,0.6);padding:10px 18px;border-radius:8px;
  color:white;font-size:18px;font-weight:bold;
}
.live-indicator{width:12px;height:12px;background:#29d029;border-radius:50%;animation:blink 1s infinite;}
@keyframes blink{0%,50%,100%{opacity:1;}25%,75%{opacity:0.2;}}
</style>
</head>
<body>

<div id="header"><span class="live-indicator"></span> Carris Metropolitana ‚Äì Live</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/gh/bbecquet/Leaflet.RotatedMarker@master/leaflet.rotatedMarker.js"></script>
<script>

// ---------- MAP SETUP ----------
const map = L.map('map').setView([38.736946, -9.142685], 13);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution:"¬© OpenStreetMap contributors"
}).addTo(map);


// ---------- ICON FACTORY ----------
function createBusSVGIcon(line){
  const maxWidth = 46;
  const height = 20;
  const padding = 3;
  const arrowW = 10;
  const rectW = Math.min(30 + line.length*5, maxWidth);
  const fontSize = (line.length>3)?10:12;

  const svg = `
    <svg xmlns="http://www.w3.org/2000/svg"
         width="${rectW + arrowW}" height="${height}">
      <rect x="0" y="0" width="${rectW}" height="${height}"
            fill="#FFD100" stroke="black" rx="3" ry="3"/>
      <text x="${padding}" y="${height/2+5}" font-size="${fontSize}"
            font-family="Arial" font-weight="bold" fill="black">
        ${line}
      </text>
      <polygon points="${rectW},${height/2-5} ${rectW},${height/2+5} ${rectW+arrowW},${height/2}"
               fill="black"/>
    </svg>`;
  
  return L.icon({
    iconUrl: "data:image/svg+xml;base64,"+btoa(svg),
    iconSize: [rectW+arrowW, height],
    iconAnchor: [(rectW+arrowW)/2, height/2]
  });
}


// ---------- UTILS ----------
function traduzirStatus(s){
  switch(s){
    case "INCOMING_AT": return "A chegar";
    case "STOPPED_AT": return "Parado";
    case "IN_TRANSIT_TO": return "Em tr√¢nsito";
    default: return s||"Desconhecido";
  }
}
function calcDistKm(lat1,lon1,lat2,lon2){
  const R=6371, dLat=(lat2-lat1)*Math.PI/180, dLon=(lon2-lon1)*Math.PI/180;
  const a=Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  return 2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))*R;
}


// ---------- PATTERN CACHE ----------
const cachePatterns = new Map();
async function fetchPattern(pattern_id){
  if(cachePatterns.has(pattern_id)) return cachePatterns.get(pattern_id);

  try{
    const res = await fetch(`https://api.carrismetropolitana.pt/v2/patterns/${pattern_id}`);
    if(!res.ok) throw new Error("sem pattern");
    const data = await res.json();
    // preprocess
    const paragens = (data.path||[])
      .map(p=>p.stop && {name:p.stop.name, lat:p.stop.lat, lon:p.stop.lon})
      .filter(Boolean);
    const info={ headsign:data.headsign||"", paragens };
    cachePatterns.set(pattern_id, info);
    return info;
  } catch(e){
    cachePatterns.set(pattern_id,{headsign:"---",paragens:[]});
    return {headsign:"---",paragens:[]};
  }
}


// ---------- VEHICLE MARKERS ----------
const markers = new Map();

async function updateVehicles(){
  try{
    const veics = await fetch("https://api.carrismetropolitana.pt/v2/vehicles")
                        .then(r=>r.json());
    
    veics.forEach(async v=>{

      const {id,lat,lon,bearing,current_status,pattern_id,speed,timestamp} = v;
      if(lat==null||lon==null) return;

      const estado=traduzirStatus(current_status);
      const hora=new Date(timestamp*1000).toLocaleTimeString("pt-PT",{hour12:false});

      const {headsign,paragens} = await fetchPattern(pattern_id);

      let tempo="n/a", velKmH = speed?Math.round(speed*3.6):0;
      if(paragens && paragens.length>0 && velKmH>0){
        const prox = paragens[0];
        const dKm = calcDistKm(lat,lon,prox.lat,prox.lon);
        tempo = Math.round((dKm/velKmH)*60)+" min";
      }

      const popup = `
        üöå <b>Linha:</b> ${v.line_id || "?"}<br>
        <b>Destino:</b> ${headsign}<br>
        <b>Velocidade:</b> ${velKmH} km/h<br>
        <b>Estado:</b> ${estado}<br>
        <b>Atualiza√ß√£o:</b> ${hora}<br>
        <b>Tempo at√© pr√≥xima parada:</b> ${tempo}<br>
        <br><b>Pr√≥ximas paragens:</b><br>
        ${(paragens.map(p=>p.name)).slice(0,5).join("<br>")}
      `;

      // cria ou atualiza
      if(!markers.has(id)){
        const icon = createBusSVGIcon(v.line_id||"?");
        const m = L.marker([lat,lon],{
          icon, rotationAngle:bearing||0, rotationOrigin:"center"
        }).addTo(map);
        m.bindPopup(popup);
        markers.set(id,{marker:m,currentPos:[lat,lon],currentAngle:bearing||0,anim:null});
      } else {
        const obj = markers.get(id);
        obj.marker._popup.setContent(popup);
        // posi√ß√£o + bearing suave
        animate(obj, [lat,lon], bearing||0);
      }
    });

  }catch(err){
    console.error("Erro v2 vehicles:",err);
  }
}


// ---------- SMOOTH MOVEMENT ----------
function lerp(a,b,t){return a+(b-a)*t;}
function interp(p1,p2,t){return [lerp(p1[0],p2[0],t),lerp(p1[1],p2[1],t)];}

function animate(obj,newPos,newAng,duration=30000){
  const start = performance.now(),
        fromPos = obj.currentPos.slice(),
        fromAng = obj.currentAngle!=null?obj.currentAngle:newAng;

  if(obj.anim) cancelAnimationFrame(obj.anim);

  function frame(ts){
    const t = Math.min((ts-start)/duration,1);
    const p = interp(fromPos,newPos,t),
          a = lerp(fromAng,newAng,t);
    obj.marker.setLatLng(p);
    obj.marker.setRotationAngle(a);
    obj.currentPos = p;
    obj.currentAngle = a;
    if(t<1) obj.anim = requestAnimationFrame(frame);
  }
  obj.anim = requestAnimationFrame(frame);
}


// ---------- START & INTERVAL ----------
updateVehicles();
setInterval(updateVehicles,30000);

</script>
</body>
</html>
