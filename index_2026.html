<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Carris Metropolitana – Live</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html,body{
  margin:0;
  height:100%;
  overflow:hidden;
  font-family:Arial;
}
#map{ height:100%; }
#header{
  position:absolute;
  top:15px;
  left:50%;
  transform:translateX(-50%);
  z-index:1000;
  background:rgba(0,0,0,0.8);
  padding:12px 20px;
  border-radius:10px;
  color:white;
  font-weight:bold;
}
</style>
</head>
<body>

<div id="header">
Carris Metropolitana – Live
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/gh/bbecquet/Leaflet.RotatedMarker@master/leaflet.rotatedMarker.js"></script>

<script>

const map = L.map('map').setView([38.736946, -9.142685], 12);

L.tileLayer(
"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
{ attribution:"© OpenStreetMap" }
).addTo(map);


// ---------- ICON ----------
function createBusIcon(line){

  const h=20;
  const rectW=30+(line.length*6);
  const arrowW=10;
  const w=rectW+arrowW;

  const svg=`
  <svg xmlns="http://www.w3.org/2000/svg"
       width="${w}" height="${h}">
    <rect width="${rectW}" height="${h}"
          fill="#FFD100" stroke="black"
          rx="4"/>
    <text x="6" y="${h/2+5}"
          font-size="12"
          font-weight="bold">
      ${line}
    </text>
    <polygon points="${rectW},${h/2-5}
                     ${rectW},${h/2+5}
                     ${w},${h/2}"
             fill="black"/>
  </svg>`;

  return L.icon({
    iconUrl:"data:image/svg+xml;base64,"+btoa(svg),
    iconSize:[w,h],
    iconAnchor:[w,h/2]
  });
}


// ---------- TRIP CACHE ----------
const tripCache=new Map();

async function fetchTrip(trip_id){

  if(!trip_id) return {headsign:"",stops:[]};
  if(tripCache.has(trip_id))
    return tripCache.get(trip_id);

  try{

    const res=await fetch(
    `https://api.carrismetropolitana.pt/v2/trips/${trip_id}`
    );

    const data=await res.json();

    const stops=(data.stop_times||[])
      .map(s=>s.stop)
      .filter(Boolean);

    const headsign=
      data.headsign ||
      (stops.length?stops[stops.length-1].name:"");

    const info={headsign,stops};

    tripCache.set(trip_id,info);
    return info;

  }catch(e){
    console.log("Erro trip:",e);
    return {headsign:"",stops:[]};
  }
}


// ---------- VEHICLES ----------
const markers=new Map();

async function update(){

  const vehicles=await fetch(
  "https://api.carrismetropolitana.pt/v2/vehicles"
  ).then(r=>r.json());

  vehicles.forEach(async v=>{

    if(!v.lat||!v.lon) return;

    const trip=await fetchTrip(v.trip_id);

    const popup=`
    <b>Linha:</b> ${v.line_id}<br>
    <b>Destino:</b> ${trip.headsign}<br>
    <b>Velocidade:</b> ${v.speed?Math.round(v.speed*3.6):0} km/h<br>
    <b>Estado:</b> ${v.current_status}<br><br>
    <b>Próximas paragens:</b><br>
    ${trip.stops.slice(0,5).map(s=>s.name).join("<br>")}
    `;

    if(!markers.has(v.id)){

      const marker=L.marker([v.lat,v.lon],{
        icon:createBusIcon(v.line_id),
        rotationAngle:v.bearing||0,
        rotationOrigin:"center center"
      }).addTo(map);

      marker.bindPopup(popup);

      markers.set(v.id,marker);

    }else{

      const m=markers.get(v.id);
      m.setLatLng([v.lat,v.lon]);
      m.setRotationAngle(v.bearing||0);
      m.getPopup().setContent(popup);
    }

  });
}

update();
setInterval(update,30000);

</script>
</body>
</html>
