<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Carris Metropolitana – Live com Rota Real</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html, body { margin:0; height:100%; font-family: Arial, sans-serif; overflow:hidden; }
#map { height:100%; }
#header{
  position:absolute;
  top:15px;
  left:50%;
  transform:translateX(-50%);
  z-index:1000;
  background:rgba(0,0,0,0.8);
  padding:12px 20px;
  border-radius:10px;
  color:white;
  font-weight:bold;
  display:flex;
  align-items:center;
  gap:10px;
}
.live-dot{
  width:12px;
  height:12px;
  background:#00ff2a;
  border-radius:50%;
  animation:blink 1s infinite;
}
@keyframes blink{
  0%,100%{opacity:1;}
  50%{opacity:0.3;}
}
</style>
</head>
<body>

<div id="header">
  <div class="live-dot"></div>
  Carris Metropolitana – Live (Rota Real)
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/gh/bbecquet/Leaflet.RotatedMarker@master/leaflet.rotatedMarker.js"></script>

<script>
// ---------------- MAP ----------------
const map = L.map('map').setView([38.736946, -9.142685], 12);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { attribution:"© OpenStreetMap contributors" }).addTo(map);

// ---------------- ICON ----------------
function createBusIcon(line){
  const h = 20;
  const rectW = 30 + (line ? line.length*6 : 10);
  const arrowW = 10;
  const w = rectW + arrowW;

  const svg = `
  <svg xmlns="http://www.w3.org/2000/svg" width="${w}" height="${h}">
    <rect width="${rectW}" height="${h}" fill="#FFD100" stroke="black" rx="4"/>
    <text x="6" y="${h/2+5}" font-size="12" font-weight="bold">${line || "?"}</text>
    <polygon points="${rectW},${h/2-5} ${rectW},${h/2+5} ${w},${h/2}" fill="black"/>
  </svg>`;

  return L.icon({
    iconUrl:"data:image/svg+xml;base64,"+btoa(svg),
    iconSize:[w,h],
    iconAnchor:[w,h/2]
  });
}

// ---------------- UTILS ----------------
function traduzirStatus(status){
  switch(status){
    case "INCOMING_AT": return "A chegar à paragem";
    case "STOPPED_AT": return "Parado na paragem";
    case "IN_TRANSIT_TO": return "Em trânsito";
    default: return status;
  }
}

// ---------------- POPUP ----------------
function lerPopup(v){
  return `
    <b>ID:</b> ${v.id}<br>
    <b>Linha:</b> ${v.line_id}<br>
    <b>Pattern:</b> ${v.pattern_id}<br>
    <b>Trip:</b> ${v.trip_id}<br>
    <b>Estado:</b> ${traduzirStatus(v.current_status)}<br>
    <b>Velocidade:</b> ${v.speed ? Math.round(v.speed*3.6) : 0} km/h<br>
    <b>Rumo:</b> ${v.bearing}°<br>
    <b>Stop ID:</b> ${v.stop_id}<br>
    <b>Portas:</b> ${v.door_status}<br>
    <b>Agência:</b> ${v.agency_id}<br>
    <b>Veículo:</b> ${v.make} ${v.model} (${v.license_plate})<br>
    <b>Capacidade:</b> ${v.capacity_total} total (${v.capacity_seated} sentados, ${v.capacity_standing} em pé)<br>
    <b>Permite bicicletas:</b> ${v.bikes_allowed ? "Sim" : "Não"}<br>
    <b>Contactless:</b> ${v.contactless ? "Sim" : "Não"}<br>
    <b>Acessível cadeira de rodas:</b> ${v.wheelchair_accessible ? "Sim" : "Não"}<br>
    <b>Propulsão:</b> ${v.propulsion}<br>
    <b>Proprietário:</b> ${v.owner}<br>
    <b>Data registo:</b> ${v.registration_date}<br>
    <b>Block ID:</b> ${v.block_id}<br>
    <b>Event ID:</b> ${v.event_id}<br>
    <b>Route ID:</b> ${v.route_id}<br>
    <b>Schedule:</b> ${v.schedule_relationship}<br>
    <b>Shift ID:</b> ${v.shift_id}<br>
    <b>Lat:</b> ${v.lat.toFixed(6)}<br>
    <b>Lon:</b> ${v.lon.toFixed(6)}<br>
    <b>Atualização:</b> ${new Date(v.timestamp*1000).toLocaleTimeString("pt-PT")}
  `;
}

// ---------------- MARKERS ----------------
const markers = new Map();
const patternsCache = new Map();

// ---------------- MOVE MARKER ----------------
function moveMarkerAlongPath(marker, path, vehicle, duration=28000){
  if(!marker._latlng || !path || path.length<2) return;

  // Encontra segmento mais próximo da posição atual
  let closestIndex = 0;
  let minDist = Infinity;
  const lat = vehicle.lat, lon = vehicle.lon;

  for(let i=0;i<path.length-1;i++){
    const d = Math.hypot(lat - path[i].lat, lon - path[i].lon);
    if(d<minDist){ minDist=d; closestIndex=i; }
  }

  // Segmento inicial e final
  const start = path[closestIndex];
  const end = path[closestIndex+1] || path[closestIndex];

  const deltaLat = end.lat - start.lat;
  const deltaLng = end.lon - start.lon;

  // Bearing real do segmento
  const rad = Math.atan2(deltaLng, deltaLat);
  const segmentBearing = rad*180/Math.PI;

  const startTime = performance.now();
  const startPos = marker.getLatLng();
  const startBearing = marker.options.rotationAngle || segmentBearing;

  function animate(time){
    const t = Math.min((time - startTime)/duration,1);
    const newLat = startPos.lat + deltaLat*t;
    const newLon = startPos.lng + deltaLng*t;

    // Diferença mínima de ângulo
    let deltaBearing = ((segmentBearing - startBearing + 540)%360)-180;
    marker.setLatLng([newLat,newLon]);
    marker.setRotationAngle(startBearing + deltaBearing*t);

    if(t<1) requestAnimationFrame(animate);
  }

  requestAnimationFrame(animate);
}

// ---------------- UPDATE VEHICLES ----------------
async function updateVehicles(){
  try{
    const vehicles = await fetch("https://api.carrismetropolitana.pt/v2/vehicles")
      .then(r=>r.json());

    for(const v of vehicles){
      if(v.lat == null || v.lon == null) continue;

      const popupContent = lerPopup(v);

      // Carregar path do pattern se não estiver em cache
      if(!patternsCache.has(v.pattern_id)){
        try{
          const patternData = await fetch(`https://api.carrismetropolitana.pt/v2/patterns/${v.pattern_id}`)
            .then(r=>r.json());
          patternsCache.set(v.pattern_id, patternData.path || []);
        }catch(e){
          console.warn("Erro ao obter pattern",v.pattern_id,e);
          patternsCache.set(v.pattern_id,[]);
        }
      }

      const path = patternsCache.get(v.pattern_id);

      if(!markers.has(v.id)){
        const marker = L.marker([v.lat,v.lon],{
          icon:createBusIcon(v.line_id),
          rotationAngle:v.bearing||0,
          rotationOrigin:"center center"
        }).addTo(map);
        marker.bindPopup(popupContent);
        markers.set(v.id, marker);
      } else {
        const marker = markers.get(v.id);
        marker.getPopup().setContent(popupContent);
        if(path.length>1) moveMarkerAlongPath(marker, path, v);
        else marker.setLatLng([v.lat,v.lon]); // fallback
      }
    }

  } catch(e){
    console.error("Erro API:", e);
  }
}

// ---------------- START ----------------
updateVehicles();
setInterval(updateVehicles,30000);
</script>
</body>
</html>
