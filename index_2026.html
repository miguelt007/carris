<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Carris Metropolitana â€“ Live</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
html, body { margin:0; height:100%; font-family: Arial, sans-serif; }
#map { height:100%; width:100%; }

#header {
  position:absolute; top:10px; left:50%; transform:translateX(-50%);
  z-index:1000; background: rgba(0,0,0,0.5); padding:10px 20px; border-radius:10px;
  display:flex; align-items:center; gap:10px; color:white; font-weight:bold; font-size:18px;
  box-shadow:0 4px 10px rgba(0,0,0,0.3);
}
.live-indicator { width:12px; height:12px; background:#27ae60; border-radius:50%; animation:blink 1s infinite; }
@keyframes blink { 0%,50%,100%{opacity:1;} 25%,75%{opacity:0.2;} }

#botao-centro {
  position:absolute; bottom:20px; right:20px; z-index:999;
  background:white; border:2px solid #333; border-radius:50%; width:48px; height:48px;
  font-size:24px; text-align:center; line-height:44px; cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,0.3);
}
.leaflet-popup-content { max-height:250px; overflow-y:auto; }
</style>
</head>
<body>

<div id="header">
  <span class="live-indicator"></span> Carris Metropolitana â€“ Live
</div>
<div id="map"></div>
<button id="botao-centro">&#9673;</button>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/gh/bbecquet/Leaflet.RotatedMarker@master/leaflet.rotatedMarker.js"></script>
<script>
// Inicializar mapa
const map = L.map('map').setView([38.736946, -9.142685], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  attribution:'Â© OpenStreetMap contributors'
}).addTo(map);

// BotÃ£o para centrar no utilizador
let marcadorUtilizador;
navigator.geolocation.watchPosition(pos=>{
  const {latitude,longitude} = pos.coords;
  if(!marcadorUtilizador) marcadorUtilizador = L.marker([latitude,longitude]).addTo(map);
  else marcadorUtilizador.setLatLng([latitude,longitude]);
});
document.getElementById('botao-centro').addEventListener('click',()=>{ if(marcadorUtilizador) map.setView(marcadorUtilizador.getLatLng(),15); });

// FunÃ§Ã£o de Ã­cone retangular com seta
function createBusSVGIcon(line){
  const rectWidth = 40;
  const height = 20;
  const padding = 4;
  const arrowWidth = 10;

  const svg = `
  <svg xmlns="http://www.w3.org/2000/svg" width="${rectWidth+arrowWidth}" height="${height}" viewBox="0 0 ${rectWidth+arrowWidth} ${height}">
    <rect x="0" y="0" width="${rectWidth}" height="${height}" fill="#FFD100" stroke="black" rx="3" ry="3"/>
    <text x="${padding}" y="${height/2 + 5}" font-size="12" text-anchor="start" fill="black" font-family="Arial" font-weight="bold">${line}</text>
    <polygon points="${rectWidth},${height/2 - 5} ${rectWidth},${height/2 + 5} ${rectWidth+arrowWidth},${height/2}" fill="black"/>
  </svg>`;
  return L.icon({
    iconUrl: "data:image/svg+xml;base64," + btoa(svg),
    iconSize: [rectWidth + arrowWidth, height],
    iconAnchor: [(rectWidth + arrowWidth)/2, height/2]
  });
}

// FunÃ§Ã£o utilitÃ¡ria para status
function traduzirStatus(status){
  switch(status){
    case "INCOMING_AT": return "A chegar Ã  paragem";
    case "STOPPED_AT": return "Parado na paragem";
    case "IN_TRANSIT_TO": return "Em trÃ¢nsito";
    default: return "Desconhecido";
  }
}

// Cache de percursos
const cachePatterns = new Map();
async function obterInfoPercurso(pattern_id){
  if(!pattern_id) return {headsign:"nÃ£o disponÃ­vel",paragens:[]};
  if(cachePatterns.has(pattern_id)) return cachePatterns.get(pattern_id);
  try{
    const res = await fetch(`https://api.carrismetropolitana.pt/patterns/${pattern_id}`);
    if(!res.ok) throw new Error();
    const dados = await res.json();
    const headsign = dados?.headsign||"nÃ£o disponÃ­vel";
    const path = dados?.path||[];
    const paragens = path.map(p=>p.stop?.name).filter(Boolean).slice(0,5);
    const info={headsign,paragens};
    cachePatterns.set(pattern_id,info);
    return info;
  }catch{return {headsign:"nÃ£o disponÃ­vel",paragens:[]};}
}

// FunÃ§Ã£o principal de carregar autocarros
let marcadoresBuses = [];
async function carregarAutocarros(){
  try{
    const veiculos = await fetch('https://api.carrismetropolitana.pt/vehicles').then(r=>r.json());
    if(!veiculos || !Array.isArray(veiculos)) return;

    // Remove todos os marcadores antigos
    marcadoresBuses.forEach(m => map.removeLayer(m));
    marcadoresBuses = [];

    // Adiciona novos marcadores
    veiculos.forEach(async v=>{
      if(!v.lat || !v.lon) return;
      const {lat, lon, id, line_id, bearing, current_status, pattern_id} = v;
      const {headsign, paragens} = await obterInfoPercurso(pattern_id);
      const estado = traduzirStatus(current_status);
      const horaAtual = new Date().toLocaleTimeString("pt-PT",{hour12:false});

      const popupHTML = `
        ðŸšŒ <strong>Autocarro ${id}</strong><br>
        <b>Linha:</b> ${line_id}<br>
        <b>Destino:</b> ${headsign}<br>
        <b>Estado:</b> ${estado}<br>
        <b>AtualizaÃ§Ã£o:</b> ${horaAtual}<br>
        <br><strong>PrÃ³ximas paragens:</strong><br>${paragens.join('<br>')}
      `;

      const marker = L.marker([lat, lon], {
        icon: createBusSVGIcon(line_id),
        rotationAngle: bearing || 0,
        rotationOrigin: 'center'
      }).addTo(map);

      marker.bindPopup(popupHTML);
      marcadoresBuses.push(marker);
    });

  }catch(err){ console.error('Erro ao carregar veÃ­culos:', err); }
}

// Inicializa e atualiza a cada 30s
carregarAutocarros();
setInterval(carregarAutocarros,30000);
</script>
</body>
</html>
